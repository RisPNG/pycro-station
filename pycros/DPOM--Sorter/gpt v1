import os
import threading
from dataclasses import dataclass, field
from datetime import datetime, timedelta, date
from typing import List, Tuple, Any, Optional, Dict

from PySide6.QtCore import Qt, Signal
from PySide6.QtWidgets import (
    QFileDialog,
    QHBoxLayout,
    QVBoxLayout,
    QLabel,
    QTextEdit,
    QWidget,
    QSizePolicy
)
from qfluentwidgets import PrimaryPushButton, MessageBox

from openpyxl import Workbook, load_workbook
from openpyxl.styles import Alignment, Border, Side, PatternFill, Font
from openpyxl.utils import get_column_letter

try:
    import xlrd  # legacy .xls detector only
except Exception:
    xlrd = None


# =============================================================================
#  Colour constants (VBA Long -> RGB)
# =============================================================================
# These come from your Module 1 header. :contentReference[oaicite:2]{index=2}
cDMagenta = 8388736
cCyan = 16776960
cPink = 12830955
cGreen = 8252325
cYellow = 12123902
cDGreen = 5287936
cDarkBlue = 16737792
cOrange = 3368703

# VBA's vbBlack / vbWhite equivalents
VB_BLACK = "00000000"
VB_WHITE = "00FFFFFF"


def vba_long_to_rgb(long_color: int) -> str:
    """Convert VBA Long BGR colour into ARGB hex for openpyxl."""
    b = long_color // (256 * 256)
    g = (long_color // 256) % 256
    r = long_color % 256
    # openpyxl expects ARGB; we'll use opaque alpha and RGB
    return f"00{r:02X}{g:02X}{b:02X}"


FILL_DMAGENTA = PatternFill("solid", fgColor=vba_long_to_rgb(cDMagenta))
FILL_CYAN = PatternFill("solid", fgColor=vba_long_to_rgb(cCyan))
FILL_PINK = PatternFill("solid", fgColor=vba_long_to_rgb(cPink))
FILL_GREEN = PatternFill("solid", fgColor=vba_long_to_rgb(cGreen))
FILL_YELLOW = PatternFill("solid", fgColor=vba_long_to_rgb(cYellow))
FILL_DGREEN = PatternFill("solid", fgColor=vba_long_to_rgb(cDGreen))
FILL_DARKBLUE = PatternFill("solid", fgColor=vba_long_to_rgb(cDarkBlue))
FILL_ORANGE = PatternFill("solid", fgColor=vba_long_to_rgb(cOrange))
FILL_BLACK = PatternFill("solid", fgColor=VB_BLACK)
FILL_WHITE = PatternFill("solid", fgColor=VB_WHITE)


# =============================================================================
#  Helper dataclasses / utilities
# =============================================================================

@dataclass
class BlindBuyItem:
    sc: str   # style code (uppercased)
    bbj: str  # job number


@dataclass
class DPOMContext:
    # Column indices (1-based) – initial defaults from VBA ProcessSS. :contentReference[oaicite:3]{index=3}
    colVendor: int = 1
    colSeasonCode: int = 2
    colSeasonYear: int = 3
    colStyle: int = 4
    colPO: int = 7
    colTradingCoPO: int = 8
    colPOLine: int = 9
    colOGAC: int = 11
    colDocTypeCode: int = 15
    colTransportation: int = 17
    colShipToCusNo: int = 18
    colShipToCusName: int = 19
    colCountry: int = 20
    colInventorySegmentCode: int = 21
    colSubCategoryDesc: int = 23
    colSizeDesc: int = 24
    colSizeQty: int = 25
    colTotalSizeQty: int = 26
    colFOB: int = 27

    # dynamic cols / sizes
    colPtr: int = 0
    sizeColStart: int = 0
    maxRow: int = 0
    maxCol: int = 0

    # blind buy collection (from Size workbook)
    blind_buy: List[BlindBuyItem] = field(default_factory=list)


def col_lett(col: int) -> str:
    return get_column_letter(col)


def normalize_size(size: Any) -> str:
    """
    Port of VBA NormalizeSize. :contentReference[oaicite:4]{index=4}
    Standardizes a size string for reliable comparison.
    """
    temp_size = str(size or "").strip().upper()
    temp_size = temp_size.replace("-", "")

    temp_size = temp_size.replace("XXXXXL", "6XL")
    temp_size = temp_size.replace("XXXXL", "5XL")
    temp_size = temp_size.replace("XXXXL", "4XL")
    temp_size = temp_size.replace("XXXL", "3XL")
    temp_size = temp_size.replace("XXL", "2XL")

    temp_size = temp_size.replace("XXXXXS", "6XS")
    temp_size = temp_size.replace("XXXXS", "5XS")
    temp_size = temp_size.replace("XXXS", "4XS")
    temp_size = temp_size.replace("XXXS", "3XS")
    temp_size = temp_size.replace("XXS", "2XS")
    return temp_size


def blind_buy_collection_contains(blind_list: List[BlindBuyItem], check_val: str) -> Tuple[bool, Optional[str]]:
    """
    Port of BlindBuyCollectionContains(blindBuyCol, checkVal) returning True/False + bbj. :contentReference[oaicite:5]{index=5}
    """
    check_val = (check_val or "").strip().upper()
    for it in blind_list:
        if it.sc == check_val:
            return True, it.bbj
    return False, None


def sort_text_as_numbers_key(value: Any):
    """
    Emulate Excel DataOption:=xlSortTextAsNumbers:
    - If text looks numeric, sort by number.
    - Else sort by text.
    """
    s = str(value or "").strip()
    if s.replace(".", "", 1).isdigit():
        # treat as float; but we only care about ordering
        try:
            return (0, float(s))
        except Exception:
            return (1, s)
    return (1, s)


# =============================================================================
#  Core process entry for multiple files
# =============================================================================

def process_files(size_file: str, files: List[str], log) -> Tuple[str, int, int]:
    """
    Main entry from UI.

    size_file: workbook containing sheets "Size" and "Blind Buy".
    files: DPOM .xlsx/.xlsm files.
    log: callable(str) for verbose logging.
    """
    log("===== DPOM Sorting Python macro START =====")
    log(f"Size / Blind Buy workbook: {size_file}")
    for p in files:
        log(f"Queued DPOM file: {p}")

    if not os.path.exists(size_file):
        log(f"[ERROR] Size / Blind Buy workbook not found: {size_file}")
        return "", 0, len(files)

    try:
        size_wb = load_workbook(size_file, data_only=True)
    except Exception as e:
        log(f"[ERROR] Failed to open size workbook: {e}")
        return "", 0, len(files)

    if "Size" not in size_wb.sheetnames:
        log("[ERROR] Sheet 'Size' not found in size workbook.")
        return "", 0, len(files)

    size_sheet = size_wb["Size"]

    blind_list: List[BlindBuyItem] = []
    if "Blind Buy" in size_wb.sheetnames:
        blind_sheet = size_wb["Blind Buy"]
        r = 2
        while r <= blind_sheet.max_row:
            sc = (blind_sheet.cell(row=r, column=1).value or "").strip().upper()
            bbj = (blind_sheet.cell(row=r, column=2).value or "").strip()
            if sc:
                blind_list.append(BlindBuyItem(sc=sc, bbj=bbj))
            r += 1
        log(f"Loaded {len(blind_list)} Blind Buy mapping rows from size workbook.")
    else:
        blind_sheet = None
        log("[INFO] No 'Blind Buy' sheet; Blind Buy logic will be disabled.")

    ok = 0
    fail = 0
    last_out = ""

    for path in files:
        log("")
        log(f"----- Processing DPOM: {os.path.basename(path)} -----")
        if not os.path.exists(path):
            log(f"[ERROR] File not found: {path}")
            fail += 1
            continue

        ext = os.path.splitext(path)[1].lower()
        if ext == ".xls":
            log(f"[WARN] Legacy .xls detected – openpyxl cannot overwrite .xls reliably. Skipping: {path}")
            fail += 1
            continue

        try:
            wb = load_workbook(path)
        except Exception as e:
            log(f"[ERROR] Cannot open workbook {path}: {e}")
            fail += 1
            continue

        ctx = DPOMContext(blind_buy=blind_list)

        try:
            process_single_dpom_workbook(wb, ctx, size_sheet, log)
            wb.save(path)
            log(f"[OK] Saved processed workbook in place: {path}")
            ok += 1
            last_out = path
        except Exception as e:
            log(f"[ERROR] Exception while processing {path}: {e}")
            fail += 1

    log("")
    log("===== DPOM Sorting Python macro END =====")
    return last_out, ok, fail


# =============================================================================
#  Per DPOM workbook pipeline (ProcessSS) :contentReference[oaicite:6]{index=6}
# =============================================================================

def process_single_dpom_workbook(
    wb: Workbook,
    ctx: DPOMContext,
    size_sheet,
    log
):
    # Worksheet references
    wsDPOM = wb.worksheets[0]
    log(f"Using first sheet as DPOM: '{wsDPOM.title}'")

    # Check header / processed marker
    if not check_file_dpom(wsDPOM, ctx, log):
        log("[INFO] Skipping file (incorrect format or already processed).")
        return

    # Duplicate DPOM sheet and create Temp
    wsRESULT = wb.copy_worksheet(wsDPOM)
    wsRESULT.title = wsDPOM.title + "-copy"
    wsTEMP = wb.create_sheet("Temp", index=wb.index(wsRESULT) + 1)

    log(f"Created result sheet '{wsRESULT.title}' and Temp sheet.")

    # In VBA they hide the window & disable ScreenUpdating, Calculation, Events,
    # and show frmProgress. We just log the steps.

    # === 1. SortRecord ===
    log("[STEP 1] SortRecord (multi-key sort)")
    sort_record(wsRESULT, ctx, log)

    # === 2. RearrangeSizeCol ===
    log("[STEP 2] RearrangeSizeCol (size headers)")
    rearrange_size_col(wsRESULT, wsTEMP, size_sheet, ctx, log)

    # === 3. FirstPass ===
    log("[STEP 3–4] FirstPass (grouping + size matrix + Overall Result)")
    first_pass(wsRESULT, ctx, log)

    # === 4. SecondPass ===
    log("[STEP 5–8] SecondPass (Style, OGAC, Style/Country/PO/AFS + BlindBuy, Colorway)")
    second_pass(wsRESULT, ctx, log)

    # === 5. AddNewColumn ===
    log("[STEP 9] AddNewColumn (Job#, Product Type, VNFOB, Destination, Blind Buy Job#, Est BusWeek)")
    add_new_column(wsRESULT, ctx, log)

    # === 6. RemoveColumn ===
    log("[STEP 10] RemoveColumn (delete Net Unit/Trading rows, borders, style truncation)")
    remove_column(wsRESULT, ctx, log)

    # === 7. RevertToOBS ===
    log("[STEP 11] RevertToOBS (rename headers, convert dates to text, insert summary rows)")
    revert_to_obs(wsRESULT, ctx, log)

    # Mark processed
    wsDPOM["AA1"].value = "PROCESSED"
    wsDPOM["AA1"].font = Font(color=VB_WHITE)
    wsRESULT["A1"].value = "PROCESSED"
    log("Marked original DPOM sheet (AA1) and result sheet (A1) as PROCESSED.")

    # AutoFit approximation
    autofit_columns(wsRESULT)

    # Delete Temp
    wb.remove(wsTEMP)
    log("Removed Temp sheet.")

    # === 8. Module2.SeparateDataGroups === :contentReference[oaicite:7]{index=7}
    log("[STEP 12] Module2.SeparateDataGroups (group splitting & black separators)")
    separate_data_groups(wsRESULT, log)

    log("DPOM workbook processing complete.")


# =============================================================================
#  CheckfileDPOM :contentReference[oaicite:8]{index=8}
# =============================================================================

def check_file_dpom(ws, ctx: DPOMContext, log) -> bool:
    if str(ws["AA1"].value or "").strip().upper() == "PROCESSED":
        log("[WARN] DPOM already processed (AA1 = 'PROCESSED').")
        return False

    # Header validation
    expected = [
        (ctx.colVendor, "Vendor Code"),
        (ctx.colSeasonCode, "Planning Season Code"),
        (ctx.colSeasonYear, "Planning Season Year"),
        (ctx.colStyle, "Product Code"),
        (ctx.colPO, "Purchase Order Number"),
        (ctx.colTradingCoPO, "Trading Co PO Number"),
        (ctx.colPOLine, "PO Line Item Number"),
        (ctx.colOGAC, "OGAC"),
        (ctx.colDocTypeCode, "Doc Type Code"),
        (ctx.colTransportation, "Mode of Transportation Code"),
        (ctx.colShipToCusNo, "Ship To Customer Number"),
        (ctx.colShipToCusName, "Ship To Customer Name"),
        (ctx.colCountry, "Destination Country"),
        (ctx.colInventorySegmentCode, "Inventory Segment Code"),
        (ctx.colSubCategoryDesc, "Sub Category Description"),
        (ctx.colSizeDesc, "Size Description"),
        (ctx.colSizeQty, "Size Quantity"),
        (ctx.colTotalSizeQty, "Total Item Quantity"),
        (ctx.colFOB, "Gross Price/FOB"),
    ]
    for col, label in expected:
        val = str(ws.cell(row=1, column=col).value or "").strip()
        if val != label:
            log(f"[ERROR] Header mismatch in column {col_lett(col)}: "
                f"expected '{label}', found '{val}'.")
            return False

    log("DPOM header check passed.")
    return True


# =============================================================================
#  SortRecord port (in-memory key build + sort) :contentReference[oaicite:9]{index=9}
# =============================================================================

def sort_record(wsRESULT, ctx: DPOMContext, log):
    ctx.maxCol = wsRESULT.cell(row=1, column=wsRESULT.max_column).column
    ctx.maxRow = wsRESULT.max_row
    start = 2
    if ctx.maxRow < start:
        return

    log(f"[SortRecord] Rows: {ctx.maxRow}, Cols: {ctx.maxCol}")

    # Build row list with sort keys
    rows = []
    for r in range(start, ctx.maxRow + 1):
        row_vals = [wsRESULT.cell(row=r, column=c).value for c in range(1, ctx.maxCol + 1)]

        style = (row_vals[ctx.colStyle - 1] or "").strip()
        style_head = style[:6] if len(style) >= 6 else style
        style_color = style[-3:] if len(style) >= 3 else style

        og = (row_vals[ctx.colOGAC - 1] or "")
        sOG = str(og).strip()
        if "/" in sOG:
            parts = sOG.split("/")
            if len(parts) >= 3:
                yy = parts[2][-4:]
                try:
                    mm = f"{int(parts[0]):02d}"
                    dd = f"{int(parts[1]):02d}"
                    og_key = yy + mm + dd
                except Exception:
                    og_key = sOG[-4:]
            else:
                og_key = sOG[-4:]
        else:
            og_key = sOG[-4:]

        season_code = str(row_vals[ctx.colSeasonCode - 1] or "").strip().upper()
        if season_code == "SP":
            sc_rank = "1"
        elif season_code == "SU":
            sc_rank = "2"
        elif season_code == "FA":
            sc_rank = "3"
        elif season_code == "HO":
            sc_rank = "4"
        else:
            sc_rank = ""

        season_year = row_vals[ctx.colSeasonYear - 1]
        po = row_vals[ctx.colPO - 1]
        poline = row_vals[ctx.colPOLine - 1]
        country = row_vals[ctx.colCountry - 1]
        ship_to = row_vals[ctx.colShipToCusNo - 1]

        rows.append((
            style_head,
            season_year,
            sc_rank,
            og_key,
            po,
            style_color,
            poline,
            country,
            ship_to,
            row_vals,
        ))

    # Sort using same key order as VBA SortFields
    rows.sort(
        key=lambda x: (
            sort_text_as_numbers_key(x[0]),      # style head
            sort_text_as_numbers_key(x[1]),      # season year
            sort_text_as_numbers_key(x[2]),      # season code rank
            str(x[3] or ""),                     # ogac key
            sort_text_as_numbers_key(x[4]),      # po
            str(x[5] or ""),                     # style colourway
            sort_text_as_numbers_key(x[6]),      # po line
            str(x[7] or ""),                     # country
            str(x[8] or ""),                     # ship to
        )
    )

    # Write back
    for idx, row_data in enumerate(rows, start=start):
        if idx % 500 == 0:
            log(f"[SortRecord] Writing row {idx}/{ctx.maxRow}")
        row_vals = row_data[9]
        for c in range(1, ctx.maxCol + 1):
            cell = wsRESULT.cell(row=idx, column=c)
            cell.value = row_vals[c - 1]
            cell.fill = PatternFill(fill_type=None)

    log("[SortRecord] Sort completed.")


# =============================================================================
#  RearrangeSizeCol (with NormalizeSize) :contentReference[oaicite:10]{index=10}
# =============================================================================

def rearrange_size_col(wsRESULT, wsTEMP, size_sheet, ctx: DPOMContext, log):
    ctx.maxCol = wsRESULT.cell(row=1, column=wsRESULT.max_column).column
    ctx.sizeColStart = ctx.maxCol + 1
    ctx.maxRow = wsRESULT.max_row
    start_data = 2

    # Copy size desc to Temp col A & deduplicate
    for r in range(start_data, ctx.maxRow + 1):
        wsTEMP.cell(row=r - start_data + 1, column=1).value = wsRESULT.cell(row=r, column=ctx.colSizeDesc).value

    # Remove duplicates (simple Python set + keep order)
    seen = set()
    unique = []
    for r in range(1, wsTEMP.max_row + 1):
        val = wsTEMP.cell(row=r, column=1).value
        if val not in seen:
            seen.add(val)
            unique.append(val)

    # Sort sizes based on Size sheet and NormalizeSize
    size_vals = []
    for r in range(2, size_sheet.max_row + 1):
        v = size_sheet.cell(row=r, column=1).value
        if v is not None:
            size_vals.append(v)

    ordered = []
    unmatched = unique.copy()
    for v in size_vals:
        nv = normalize_size(v)
        found_index = None
        for i, u in enumerate(unmatched):
            if normalize_size(u) == nv:
                found_index = i
                break
        if found_index is not None:
            ordered.append(unmatched.pop(found_index))

    ordered.extend(unmatched)

    # Temp col B for ordered sizes
    for idx, v in enumerate(ordered, start=1):
        wsTEMP.cell(row=idx, column=2).value = v

    # Write size headers to wsRESULT
    maxRowTemp = len(ordered)
    for i in range(1, maxRowTemp + 1):
        if i % 100 == 0:
            log(f"[RearrangeSizeCol] Writing size header {i}/{maxRowTemp}")
        wsRESULT.cell(row=1, column=ctx.maxCol + i).value = (wsTEMP.cell(row=i, column=2).value or "").strip()

    ctx.maxCol = ctx.maxCol + maxRowTemp
    log(f"[RearrangeSizeCol] Done. sizeColStart={ctx.sizeColStart}, maxCol={ctx.maxCol}")


# =============================================================================
#  FirstPass (grouping & Overall Result) :contentReference[oaicite:11]{index=11}
# =============================================================================

def first_pass(wsRESULT, ctx: DPOMContext, log):
    maxCol = wsRESULT.cell(row=1, column=wsRESULT.max_column).column
    maxRow = wsRESULT.max_row
    ctx.maxCol = maxCol
    ctx.maxRow = maxRow
    start = 2
    startPtr = start
    sizeColStart = ctx.sizeColStart

    # Insert overall result / total labels
    wsRESULT.cell(row=1, column=maxCol + 1).value = "Overall Result"
    wsRESULT.cell(row=maxRow + 1, column=1).value = "Overall Result"
    wsRESULT.cell(row=maxRow + 1, column=maxCol + 2).value = "Total Item Qty"

    # Build normalized size header map
    sizeMap: Dict[str, int] = {}
    for col in range(sizeColStart, maxCol + 1):
        hdr = wsRESULT.cell(row=1, column=col).value
        key = normalize_size(hdr)
        if key and key not in sizeMap:
            sizeMap[key] = col

    log(f"[FirstPass] Size header map has {len(sizeMap)} entries.")

    def get_keys(r: int):
        return (
            str(wsRESULT.cell(row=r, column=ctx.colSeasonCode).value or "").strip(),
            str(wsRESULT.cell(row=r, column=ctx.colSeasonYear).value or "").strip(),
            str(wsRESULT.cell(row=r, column=ctx.colStyle).value or "").strip(),
            str(wsRESULT.cell(row=r, column=ctx.colPO).value or "").strip(),
            str(wsRESULT.cell(row=r, column=ctx.colPOLine).value or "").strip(),
            str(wsRESULT.cell(row=r, column=ctx.colShipToCusNo).value or "").strip(),
            str(wsRESULT.cell(row=r, column=ctx.colShipToCusName).value or "").strip(),
            str(wsRESULT.cell(row=r, column=ctx.colTotalSizeQty).value or "").strip(),
        )

    while start <= maxRow:
        if start % 500 == 0:
            log(f"[FirstPass] grouping at row {start}/{maxRow}")

        key0 = get_keys(start)
        key1 = get_keys(start + 1) if start + 1 <= maxRow else ("",) * 8

        if key0 != key1:
            endPtr = start
            # Insert two new rows by copying as VBA does:
            # we emulate by inserting 2 rows and then adjusting startPtr->endPtr range
            wsRESULT.cell(row=endPtr, column=maxCol + 2).value = "Total Item Qty"
            # Copy row for Trading Co Net Unit Price
            wsRESULT.insert_rows(endPtr + 1)
            wsRESULT.insert_rows(endPtr + 1)
            wsRESULT.cell(row=endPtr + 1, column=maxCol + 2).value = "Trading Co Net Unit Price"
            wsRESULT.cell(row=endPtr + 2, column=maxCol + 2).value = "Net Unit Price"

            # Grouping: startPtr..endPtr
            while startPtr <= endPtr:
                sizeKey = normalize_size(wsRESULT.cell(row=startPtr, column=ctx.colSizeDesc).value)
                qty_val = wsRESULT.cell(row=startPtr, column=ctx.colSizeQty).value
                fob_val = wsRESULT.cell(row=startPtr, column=ctx.colFOB).value

                tgt_col = sizeMap.get(sizeKey)
                if tgt_col is None:
                    # fallback linear scan
                    for sizeColPtr in range(sizeColStart, maxCol + 1):
                        if normalize_size(wsRESULT.cell(row=1, column=sizeColPtr).value) == sizeKey:
                            tgt_col = sizeColPtr
                            break

                if tgt_col is not None:
                    wsRESULT.cell(row=endPtr, column=tgt_col).value = qty_val
                    wsRESULT.cell(row=endPtr + 1, column=tgt_col).value = fob_val
                    wsRESULT.cell(row=endPtr + 2, column=tgt_col).value = fob_val

                startPtr += 1

            # Total per group row across size columns
            group_total = 0
            for col in range(sizeColStart, maxCol + 1):
                v = wsRESULT.cell(row=endPtr, column=col).value
                if isinstance(v, (int, float)):
                    group_total += v
            wsRESULT.cell(row=endPtr, column=maxCol + 1).value = group_total

            startPtr = endPtr + 3
            start = endPtr + 2
            maxRow = wsRESULT.max_row

        start += 1

    # Column totals at bottom for all sizes and Overall Result
    for col in range(sizeColStart, maxCol + 2):
        total = 0
        for r in range(2, maxRow + 1):
            if wsRESULT.cell(row=r, column=maxCol + 2).value == "Total Item Qty":
                v = wsRESULT.cell(row=r, column=col).value
                if isinstance(v, (int, float)):
                    total += v
        wsRESULT.cell(row=maxRow + 1, column=col).value = total

    # Clean blanks where label col is empty
    row = 2
    while row <= maxRow:
        if not wsRESULT.cell(row=row, column=maxCol + 2).value:
            wsRESULT.delete_rows(row)
            maxRow -= 1
        else:
            row += 1

    # Move label column (maxCol+2) before ShipToCusNo
    from_col = maxCol + 2
    to_col = ctx.colShipToCusNo
    move_column(wsRESULT, from_col, to_col)

    # Adjust col indices and delete original size columns
    ctx.colSizeDesc += 1
    ctx.colSizeQty += 1
    ctx.colTotalSizeQty += 1
    ctx.colFOB += 1

    wsRESULT.delete_cols(ctx.colSizeDesc, ctx.colFOB - ctx.colSizeDesc + 1)

    ctx.colPtr = ctx.colShipToCusNo
    ctx.colShipToCusNo += 1
    ctx.colShipToCusName += 1
    ctx.colCountry += 1
    ctx.colInventorySegmentCode += 1
    ctx.colSubCategoryDesc += 1
    ctx.sizeColStart = ctx.sizeColStart - 3

    ctx.maxCol = wsRESULT.cell(row=1, column=wsRESULT.max_column).column
    ctx.maxRow = wsRESULT.max_row
    log(f"[FirstPass] Completed. maxRow={ctx.maxRow}, sizeColStart={ctx.sizeColStart}")


def move_column(ws, from_col: int, to_col: int):
    max_row = ws.max_row
    data = [ws.cell(row=r, column=from_col).value for r in range(1, max_row + 1)]
    ws.delete_cols(from_col)
    if from_col < to_col:
        to_col -= 1
    ws.insert_cols(to_col)
    for r in range(1, max_row + 1):
        ws.cell(row=r, column=to_col).value = data[r - 1]


# =============================================================================
#  SecondPass – full port (Style, OGAC, Style/Country/PO/AFS+BlindBuy, Colorway)
# =============================================================================

def second_pass(wsRESULT, ctx: DPOMContext, log):
    # We closely follow your VBA SecondPass, section by section. :contentReference[oaicite:12]{index=12}
    maxCol = wsRESULT.cell(row=1, column=wsRESULT.max_column).column
    maxRow = wsRESULT.max_row
    sizeColStart = ctx.sizeColStart
    colPtr = ctx.colPtr

    # -------------------------------------------------------------------------
    # 1) Style grouping (green)
    # -------------------------------------------------------------------------
    log("[SecondPass] Style grouping (green rows).")
    start = 2
    startPtr = start

    def style_head(row):
        s = str(wsRESULT.cell(row=row, column=ctx.colStyle).value or "").strip().upper()
        if s and "-" in s:
            return s.split("-", 1)[0]
        return s

    curr_st = style_head(start)
    prev_st = curr_st

    while start <= maxRow:
        if start % 300 == 0:
            log(f"[SecondPass-Style] row {start}/{maxRow}")

        if curr_st != prev_st:
            endPtr = start - 1

            # labelArr: colPtr from startPtr..endPtr
            labels = [
                wsRESULT.cell(row=r, column=colPtr).value
                for r in range(startPtr, endPtr + 1)
            ]
            rowsCount = len(labels)

            # sizeArr: rows startPtr..endPtr+2, cols sizeColStart..maxCol-1
            colsCount = (maxCol - 1) - sizeColStart + 1
            sizeArr = []
            for r in range(startPtr, endPtr + 3):
                sizeArr.append([
                    wsRESULT.cell(row=r, column=c).value
                    for c in range(sizeColStart, maxCol)
                ])

            # Find last "Total Item Qty" row
            pointIdx = 0
            for i in range(rowsCount):
                if labels[i] == "Total Item Qty":
                    pointIdx = i + 1
            if pointIdx == 0:
                pointIdx = rowsCount
            point = startPtr + pointIdx - 1

            qtyRow = ["" for _ in range(colsCount)]
            m1Row = ["" for _ in range(colsCount)]
            m2Row = ["" for _ in range(colsCount)]
            total_sum1 = 0
            total_sum2 = 0

            for j in range(colsCount):
                s_sum = 0
                money_1 = None
                money_2 = None
                for i in range(rowsCount):
                    if labels[i] == "Total Item Qty":
                        v = sizeArr[i][j]
                        if isinstance(v, (int, float)):
                            s_sum += v
                        v1 = sizeArr[i + 1][j]
                        if v1 not in (None, ""):
                            money_1 = v1
                        v2 = sizeArr[i + 2][j]
                        if v2 not in (None, ""):
                            money_2 = v2
                qtyRow[j] = "" if s_sum == 0 else s_sum
                m1Row[j] = "" if (not money_1 or money_1 == 0) else money_1
                m2Row[j] = "" if (not money_2 or money_2 == 0) else money_2
                total_sum1 += s_sum * (0 if (not money_1 or money_1 == 0) else money_1)
                total_sum2 += s_sum * (0 if (not money_2 or money_2 == 0) else money_2)

            # Insert 4 rows at 'start'
            wsRESULT.insert_rows(start, amount=4)
            maxRow = wsRESULT.max_row

            # Copy metadata:
            # point+1 -> start+1; point+2 -> start+2; point -> start (A..colPtr)
            for c in range(1, ctx.sizeColStart + 1):
                wsRESULT.cell(row=start + 1, column=c).value = wsRESULT.cell(row=point + 1, column=c).value
                wsRESULT.cell(row=start + 2, column=c).value = wsRESULT.cell(row=point + 2, column=c).value

            for c in range(1, colPtr + 1):
                wsRESULT.cell(row=start, column=c).value = wsRESULT.cell(row=point, column=c).value
            wsRESULT.cell(row=start, column=colPtr).value = "Total Style Qty"

            # Fill sizes & money rows
            for j in range(colsCount):
                col = sizeColStart + j
                wsRESULT.cell(row=start, column=col).number_format = "General"
                wsRESULT.cell(row=start, column=col).value = qtyRow[j]
                wsRESULT.cell(row=start + 1, column=col).number_format = "General"
                wsRESULT.cell(row=start + 1, column=col).value = m1Row[j]
                wsRESULT.cell(row=start + 2, column=col).number_format = "General"
                wsRESULT.cell(row=start + 2, column=col).value = m2Row[j]

            # Format rows
            for c in range(1, maxCol + 1):
                for r in (start,):
                    cell = wsRESULT.cell(row=r, column=c)
                    cell.fill = FILL_GREEN
                    cell.font = (cell.font or Font()).copy(bold=True)
                for r in (start + 1, start + 2):
                    cell = wsRESULT.cell(row=r, column=c)
                    cell.fill = FILL_GREEN
                    cell.font = (cell.font or Font()).copy(bold=True)

            for c in range(1, maxCol + 1):
                cell = wsRESULT.cell(row=start + 3, column=c)
                cell.fill = FILL_DGREEN
            wsRESULT.row_dimensions[start + 3].height = 5

            # Style-level money totals
            wsRESULT.cell(row=start + 1, column=maxCol + 1).value = total_sum1
            cell = wsRESULT.cell(row=start + 1, column=maxCol + 1)
            cell.fill = FILL_GREEN
            cell.font = (cell.font or Font()).copy(bold=True)

            wsRESULT.cell(row=start + 2, column=maxCol + 1).value = total_sum2
            cell = wsRESULT.cell(row=start + 2, column=maxCol + 1)
            cell.fill = FILL_GREEN
            cell.font = (cell.font or Font()).copy(bold=True)

            # Style-level qty total in Overall Result column (maxCol)
            total_overall = 0
            for r in range(startPtr, endPtr + 1):
                if wsRESULT.cell(row=r, column=colPtr).value == "Total Item Qty":
                    v = wsRESULT.cell(row=r, column=maxCol).value
                    if isinstance(v, (int, float)):
                        total_overall += v
            wsRESULT.cell(row=start, column=maxCol).value = total_overall

            maxRow = wsRESULT.max_row
            start = start + 4
            startPtr = start
            prev_st = curr_st

        start += 1
        if start <= maxRow:
            curr_st = style_head(start)

    # -------------------------------------------------------------------------
    # 2) OGAC grouping (pink)
    # -------------------------------------------------------------------------
    log("[SecondPass] OGAC grouping (pink rows).")
    maxRow = wsRESULT.max_row
    start = 2
    startPtr = start
    labelColLett = col_lett(colPtr)
    maxColLett = col_lett(maxCol)
    sizeColLetters = {c: col_lett(c) for c in range(sizeColStart, maxCol)}

    while start <= maxRow:
        if start % 300 == 0:
            log(f"[SecondPass-OGAC] row {start}/{maxRow}")

        if wsRESULT.cell(row=start, column=colPtr).value == "Total Style Qty":
            innerStartPtr = startPtr
            endPtr = start
            curr_ogac = str(wsRESULT.cell(row=startPtr, column=ctx.colOGAC).value or "").upper().strip()
            prev_ogac = curr_ogac

            while startPtr <= endPtr:
                curr_ogac = str(wsRESULT.cell(row=startPtr, column=ctx.colOGAC).value or "").upper().strip()

                if curr_ogac != prev_ogac:
                    # Find last Total Item Qty between innerStartPtr..startPtr-1
                    point = innerStartPtr
                    for r in range(startPtr - 1, innerStartPtr - 1, -1):
                        if wsRESULT.cell(row=r, column=colPtr).value == "Total Item Qty":
                            point = r
                            break

                    wsRESULT.insert_rows(startPtr, amount=2)

                    # Copy metadata
                    for c in range(1, colPtr + 1):
                        wsRESULT.cell(row=startPtr, column=c).value = wsRESULT.cell(row=point, column=c).value
                    wsRESULT.cell(row=startPtr, column=colPtr).value = "Total OGAC Qty"

                    # Sum per size for this OGAC block
                    for sizeCol in range(sizeColStart, maxCol):
                        s_sum = 0
                        for r in range(innerStartPtr, startPtr):
                            if wsRESULT.cell(row=r, column=colPtr).value == "Total Item Qty":
                                v = wsRESULT.cell(row=r, column=sizeCol).value
                                if isinstance(v, (int, float)):
                                    s_sum += v
                        cell = wsRESULT.cell(row=startPtr, column=sizeCol)
                        cell.number_format = "General"
                        cell.value = s_sum if s_sum != 0 else None

                    # Format row + overall sum
                    for c in range(1, maxCol + 1):
                        cell = wsRESULT.cell(row=startPtr, column=c)
                        cell.fill = FILL_PINK
                        cell.font = (cell.font or Font()).copy(bold=True)

                    total_overall = 0
                    for r in range(innerStartPtr, startPtr):
                        if wsRESULT.cell(row=r, column=colPtr).value == "Total Item Qty":
                            v = wsRESULT.cell(row=r, column=maxCol).value
                            if isinstance(v, (int, float)):
                                total_overall += v
                    wsRESULT.cell(row=startPtr, column=maxCol).value = total_overall

                    # Spacer row
                    for c in range(1, maxCol + 1):
                        cell = wsRESULT.cell(row=startPtr + 1, column=c)
                        cell.fill = FILL_PINK
                    wsRESULT.row_dimensions[startPtr + 1].height = 5

                    maxRow = wsRESULT.max_row
                    start += 2
                    endPtr += 2
                    innerStartPtr = startPtr + 2
                    startPtr += 1
                    prev_ogac = str(wsRESULT.cell(row=innerStartPtr, column=ctx.colOGAC).value or "").upper().strip()

                if wsRESULT.cell(row=startPtr, column=colPtr).value == "Total Style Qty":
                    # do OGAC total for the last style chunk
                    point = innerStartPtr
                    for r in range(startPtr - 1, innerStartPtr - 1, -1):
                        if wsRESULT.cell(row=r, column=colPtr).value == "Total Item Qty":
                            point = r
                            break

                    wsRESULT.insert_rows(startPtr, amount=2)

                    for c in range(1, colPtr + 1):
                        wsRESULT.cell(row=startPtr, column=c).value = wsRESULT.cell(row=point, column=c).value
                    wsRESULT.cell(row=startPtr, column=colPtr).value = "Total OGAC Qty"

                    for sizeCol in range(sizeColStart, maxCol):
                        s_sum = 0
                        for r in range(innerStartPtr, startPtr):
                            if wsRESULT.cell(row=r, column=colPtr).value == "Total Item Qty":
                                v = wsRESULT.cell(row=r, column=sizeCol).value
                                if isinstance(v, (int, float)):
                                    s_sum += v
                        cell = wsRESULT.cell(row=startPtr, column=sizeCol)
                        cell.number_format = "General"
                        cell.value = s_sum if s_sum != 0 else None

                    for c in range(1, maxCol + 1):
                        cell = wsRESULT.cell(row=startPtr, column=c)
                        cell.fill = FILL_PINK
                        cell.font = (cell.font or Font()).copy(bold=True)

                    total_overall = 0
                    for r in range(innerStartPtr, startPtr):
                        if wsRESULT.cell(row=r, column=colPtr).value == "Total Item Qty":
                            v = wsRESULT.cell(row=r, column=maxCol).value
                            if isinstance(v, (int, float)):
                                total_overall += v
                    wsRESULT.cell(row=startPtr, column=maxCol).value = total_overall

                    for c in range(1, maxCol + 1):
                        cell = wsRESULT.cell(row=startPtr + 1, column=c)
                        cell.fill = FILL_PINK
                    wsRESULT.row_dimensions[startPtr + 1].height = 5

                    maxRow = wsRESULT.max_row
                    start += 2

                startPtr += 1
                if startPtr > wsRESULT.max_row:
                    break
                prev_ogac = curr_ogac

            start += 1
            startPtr = start + 1

        else:
            start += 1

    # -------------------------------------------------------------------------
    # 3) Style/Country/PO/AFS + Blind Buy (yellow + black separators)
    # -------------------------------------------------------------------------
    log("[SecondPass] Style/Country/PO/AFS + Blind Buy grouping (yellow).")
    maxRow = wsRESULT.max_row
    start = 2
    startPtr = start

    # Build blind buy collection already loaded in ctx.blind_buy
    def is_blind(style_val: str) -> bool:
        found, _ = blind_buy_collection_contains(ctx.blind_buy, style_val)
        return found

    while start <= maxRow:
        if start % 300 == 0:
            log(f"[SecondPass-PO/AFS] row {start}/{maxRow}")

        if wsRESULT.cell(row=start, column=colPtr).value == "Total OGAC Qty":
            innerStartPtr = startPtr
            endPtr = start - 1

            def row_vals(r: int):
                return (
                    str(wsRESULT.cell(row=r, column=ctx.colCountry).value or "").upper().strip(),
                    str(wsRESULT.cell(row=r, column=ctx.colPO).value or "").upper().strip(),
                    str(wsRESULT.cell(row=r, column=ctx.colInventorySegmentCode).value or "").upper().strip(),
                    str(wsRESULT.cell(row=r, column=ctx.colShipToCusNo).value or "").upper().strip(),
                    str(wsRESULT.cell(row=r, column=ctx.colStyle).value or "").upper().strip(),
                )

            curr_coun, curr_po, curr_afs, curr_ship, curr_style = row_vals(innerStartPtr)
            prev_coun, prev_po, prev_afs, prev_ship, _ = curr_coun, curr_po, curr_afs, curr_ship, curr_style

            while startPtr <= endPtr:
                curr_coun, curr_po, curr_afs, curr_ship, curr_style = row_vals(startPtr)

                changed = (
                    curr_coun != prev_coun or
                    curr_po != prev_po or
                    curr_afs != prev_afs or
                    curr_ship != prev_ship or
                    is_blind(curr_style)
                )

                if changed:
                    # Branch depending on blind buy
                    if is_blind(curr_style):
                        prev_style = str(wsRESULT.cell(row=startPtr - 1, column=ctx.colStyle).value or "").upper().strip()
                        prev_blind = is_blind(prev_style)
                        if (not prev_blind) and startPtr != 2 and wsRESULT.cell(row=startPtr - 1, column=colPtr).value:
                            # Non-blind chunk before blind, close previous PO chunk
                            # Find last Total Item Qty row
                            point = innerStartPtr
                            for r in range(startPtr - 1, innerStartPtr - 1, -1):
                                if wsRESULT.cell(row=r, column=colPtr).value == "Total Item Qty":
                                    point = r
                                    break

                            wsRESULT.insert_rows(startPtr, amount=4)

                            # Insert PO total block (3 rows + black)
                            # Copy from point rows
                            for c in range(1, maxCol + 1):
                                wsRESULT.cell(row=startPtr + 1, column=c).value = wsRESULT.cell(row=point + 1, column=c).value
                                wsRESULT.cell(row=startPtr + 2, column=c).value = wsRESULT.cell(row=point + 2, column=c).value
                            for c in range(1, maxCol + 1):
                                cell1 = wsRESULT.cell(row=startPtr + 1, column=c)
                                cell2 = wsRESULT.cell(row=startPtr + 2, column=c)
                                cell1.fill = FILL_YELLOW
                                cell1.font = (cell1.font or Font()).copy(bold=True)
                                cell2.fill = FILL_YELLOW
                                cell2.font = (cell2.font or Font()).copy(bold=True)

                            for c in range(1, colPtr + 1):
                                wsRESULT.cell(row=startPtr, column=c).value = wsRESULT.cell(row=point, column=c).value
                            wsRESULT.cell(row=startPtr, column=colPtr).value = "Total PO Qty"

                            # Sum and money1/2
                            total_sum1 = 0
                            total_sum2 = 0
                            for sizeCol in range(sizeColStart, maxCol):
                                s_sum = 0
                                money_1 = None
                                money_2 = None
                                for r in range(innerStartPtr, startPtr):
                                    if wsRESULT.cell(row=r, column=colPtr).value == "Total Item Qty":
                                        v = wsRESULT.cell(row=r, column=sizeCol).value
                                        if isinstance(v, (int, float)):
                                            s_sum += v
                                        if wsRESULT.cell(row=r + 1, column=sizeCol).value not in (None, "") and money_1 is None:
                                            money_1 = wsRESULT.cell(row=r + 1, column=sizeCol).value
                                        if wsRESULT.cell(row=r + 2, column=sizeCol).value not in (None, "") and money_2 is None:
                                            money_2 = wsRESULT.cell(row=r + 2, column=sizeCol).value

                                wsRESULT.cell(row=startPtr, column=sizeCol).value = s_sum if s_sum != 0 else None
                                wsRESULT.cell(row=startPtr + 1, column=sizeCol).value = money_1 if money_1 else None
                                wsRESULT.cell(row=startPtr + 2, column=sizeCol).value = money_2 if money_2 else None

                                total_sum1 += (s_sum * (money_1 or 0))
                                total_sum2 += (s_sum * (money_2 or 0))

                            for c in range(1, maxCol + 1):
                                cell = wsRESULT.cell(row=startPtr, column=c)
                                cell.fill = FILL_YELLOW
                                cell.font = (cell.font or Font()).copy(bold=True)

                            # Overall result sum for PO
                            total_overall = 0
                            for r in range(innerStartPtr, startPtr):
                                if wsRESULT.cell(row=r, column=colPtr).value == "Total Item Qty":
                                    v = wsRESULT.cell(row=r, column=maxCol).value
                                    if isinstance(v, (int, float)):
                                        total_overall += v
                            wsRESULT.cell(row=startPtr, column=maxCol).value = total_overall

                            # Black row
                            for c in range(1, maxCol + 1):
                                wsRESULT.cell(row=startPtr + 3, column=c).fill = FILL_BLACK
                            wsRESULT.row_dimensions[startPtr + 3].height = 5

                            # Write money sums
                            cell = wsRESULT.cell(row=startPtr + 1, column=maxCol + 1)
                            cell.value = total_sum1
                            cell.fill = FILL_YELLOW
                            cell.font = (cell.font or Font()).copy(bold=True)
                            cell = wsRESULT.cell(row=startPtr + 2, column=maxCol + 1)
                            cell.value = total_sum2
                            cell.fill = FILL_YELLOW
                            cell.font = (cell.font or Font()).copy(bold=True)

                            maxRow = wsRESULT.max_row
                            start += 4
                            endPtr += 4
                            startPtr += 4
                            innerStartPtr = startPtr

                        # Now handle blind-buy group itself
                        wsRESULT.insert_rows(startPtr + 3, amount=4)
                        # Total PO Qty row for blind group
                        for c in range(1, colPtr + 1):
                            wsRESULT.cell(row=startPtr + 3, column=c).value = wsRESULT.cell(row=startPtr, column=c).value
                        wsRESULT.cell(row=startPtr + 3, column=colPtr).value = "Total PO Qty"

                        # Copy money rows & colour
                        for c in range(1, maxCol + 1):
                            wsRESULT.cell(row=startPtr + 4, column=c).value = wsRESULT.cell(row=startPtr + 1, column=c).value
                            wsRESULT.cell(row=startPtr + 5, column=c).value = wsRESULT.cell(row=startPtr + 2, column=c).value
                        for r in (startPtr + 4, startPtr + 5):
                            for c in range(1, maxCol + 1):
                                cell = wsRESULT.cell(row=r, column=c)
                                cell.fill = FILL_YELLOW
                                cell.font = (cell.font or Font()).copy(bold=True)

                        total_sum1 = 0
                        total_sum2 = 0
                        for sizeCol in range(sizeColStart, maxCol):
                            s_sum = 0
                            money_1 = None
                            money_2 = None
                            for r in range(innerStartPtr, startPtr + 3):
                                if wsRESULT.cell(row=r, column=colPtr).value == "Total Item Qty":
                                    v = wsRESULT.cell(row=r, column=sizeCol).value
                                    if isinstance(v, (int, float)):
                                        s_sum += v
                                    if wsRESULT.cell(row=r + 1, column=sizeCol).value not in (None, "") and money_1 is None:
                                        money_1 = wsRESULT.cell(row=r + 1, column=sizeCol).value
                                    if wsRESULT.cell(row=r + 2, column=sizeCol).value not in (None, "") and money_2 is None:
                                        money_2 = wsRESULT.cell(row=r + 2, column=sizeCol).value

                            wsRESULT.cell(row=startPtr + 3, column=sizeCol).value = s_sum if s_sum != 0 else None
                            wsRESULT.cell(row=startPtr + 4, column=sizeCol).value = money_1 if money_1 else None
                            wsRESULT.cell(row=startPtr + 5, column=sizeCol).value = money_2 if money_2 else None

                            total_sum1 += s_sum * (money_1 or 0)
                            total_sum2 += s_sum * (money_2 or 0)

                        for c in range(1, maxCol + 1):
                            cell = wsRESULT.cell(row=startPtr + 3, column=c)
                            cell.fill = FILL_YELLOW
                            cell.font = (cell.font or Font()).copy(bold=True)

                        total_overall = 0
                        for r in range(innerStartPtr, startPtr + 3):
                            if wsRESULT.cell(row=r, column=colPtr).value == "Total Item Qty":
                                v = wsRESULT.cell(row=r, column=maxCol).value
                                if isinstance(v, (int, float)):
                                    total_overall += v
                        wsRESULT.cell(row=startPtr + 3, column=maxCol).value = total_overall

                        # trailing black row
                        for c in range(1, maxCol + 1):
                            wsRESULT.cell(row=startPtr + 6, column=c).fill = FILL_BLACK
                        wsRESULT.row_dimensions[startPtr + 6].height = 5

                        # money totals
                        cell = wsRESULT.cell(row=startPtr + 4, column=maxCol + 1)
                        cell.value = total_sum1
                        cell.fill = FILL_YELLOW
                        cell.font = (cell.font or Font()).copy(bold=True)
                        cell = wsRESULT.cell(row=startPtr + 5, column=maxCol + 1)
                        cell.value = total_sum2
                        cell.fill = FILL_YELLOW
                        cell.font = (cell.font or Font()).copy(bold=True)

                        maxRow = wsRESULT.max_row
                        endPtr += 4
                        start += 4
                        startPtr += 6
                        innerStartPtr = startPtr + 1

                        # update prev values
                        if startPtr + 1 <= maxRow:
                            prev_coun = str(wsRESULT.cell(row=startPtr + 1, column=ctx.colCountry).value or "").upper().strip()
                            prev_po = str(wsRESULT.cell(row=startPtr + 1, column=ctx.colPO).value or "").upper().strip()
                            prev_afs = str(wsRESULT.cell(row=startPtr + 1, column=ctx.colInventorySegmentCode).value or "").upper().strip()
                            prev_ship = str(wsRESULT.cell(row=startPtr + 1, column=ctx.colShipToCusNo).value or "").upper().strip()
                    else:
                        # Non-blind-buy branch – simpler PO grouping
                        point = innerStartPtr
                        for r in range(startPtr - 1, innerStartPtr - 1, -1):
                            if wsRESULT.cell(row=r, column=colPtr).value == "Total Item Qty":
                                point = r
                                break

                        wsRESULT.insert_rows(startPtr, amount=4)

                        for c in range(1, maxCol + 1):
                            wsRESULT.cell(row=startPtr + 1, column=c).value = wsRESULT.cell(row=point + 1, column=c).value
                            wsRESULT.cell(row=startPtr + 2, column=c).value = wsRESULT.cell(row=point + 2, column=c).value
                        for r in (startPtr + 1, startPtr + 2):
                            for c in range(1, maxCol + 1):
                                cell = wsRESULT.cell(row=r, column=c)
                                cell.fill = FILL_YELLOW
                                cell.font = (cell.font or Font()).copy(bold=True)
                        for c in range(1, colPtr + 1):
                            wsRESULT.cell(row=startPtr, column=c).value = wsRESULT.cell(row=point, column=c).value
                        wsRESULT.cell(row=startPtr, column=colPtr).value = "Total PO Qty"

                        total_sum1 = 0
                        total_sum2 = 0
                        for sizeCol in range(sizeColStart, maxCol):
                            s_sum = 0
                            money_1 = None
                            money_2 = None
                            for r in range(innerStartPtr, startPtr):
                                if wsRESULT.cell(row=r, column=colPtr).value == "Total Item Qty":
                                    v = wsRESULT.cell(row=r, column=sizeCol).value
                                    if isinstance(v, (int, float)):
                                        s_sum += v
                                    if wsRESULT.cell(row=r + 1, column=sizeCol).value not in (None, "") and money_1 is None:
                                        money_1 = wsRESULT.cell(row=r + 1, column=sizeCol).value
                                    if wsRESULT.cell(row=r + 2, column=sizeCol).value not in (None, "") and money_2 is None:
                                        money_2 = wsRESULT.cell(row=r + 2, column=sizeCol).value

                            wsRESULT.cell(row=startPtr, column=sizeCol).value = s_sum if s_sum != 0 else None
                            wsRESULT.cell(row=startPtr + 1, column=sizeCol).value = money_1 if money_1 else None
                            wsRESULT.cell(row=startPtr + 2, column=sizeCol).value = money_2 if money_2 else None

                            total_sum1 += s_sum * (money_1 or 0)
                            total_sum2 += s_sum * (money_2 or 0)

                        for c in range(1, maxCol + 1):
                            cell = wsRESULT.cell(row=startPtr, column=c)
                            cell.fill = FILL_YELLOW
                            cell.font = (cell.font or Font()).copy(bold=True)

                        total_overall = 0
                        for r in range(innerStartPtr, startPtr):
                            if wsRESULT.cell(row=r, column=colPtr).value == "Total Item Qty":
                                v = wsRESULT.cell(row=r, column=maxCol).value
                                if isinstance(v, (int, float)):
                                    total_overall += v
                        wsRESULT.cell(row=startPtr, column=maxCol).value = total_overall

                        # black row
                        for c in range(1, maxCol + 1):
                            wsRESULT.cell(row=startPtr + 3, column=c).fill = FILL_BLACK
                        wsRESULT.row_dimensions[startPtr + 3].height = 5

                        cell = wsRESULT.cell(row=startPtr + 1, column=maxCol + 1)
                        cell.value = total_sum1
                        cell.fill = FILL_YELLOW
                        cell.font = (cell.font or Font()).copy(bold=True)
                        cell = wsRESULT.cell(row=startPtr + 2, column=maxCol + 1)
                        cell.value = total_sum2
                        cell.fill = FILL_YELLOW
                        cell.font = (cell.font or Font()).copy(bold=True)

                        maxRow = wsRESULT.max_row
                        endPtr += 4
                        start += 4
                        startPtr += 3
                        innerStartPtr = startPtr + 1
                        prev_coun = curr_coun
                        prev_po = curr_po
                        prev_afs = curr_afs
                        prev_ship = curr_ship

                startPtr += 1
                if startPtr > maxRow:
                    break

                # If we hit next "Total OGAC Qty" and not blind buy, close last chunk
                if (wsRESULT.cell(row=startPtr, column=colPtr).value == "Total OGAC Qty"
                        and not is_blind(str(wsRESULT.cell(row=startPtr, column=ctx.colStyle).value or ""))):
                    point = innerStartPtr
                    for r in range(startPtr - 1, innerStartPtr - 1, -1):
                        if wsRESULT.cell(row=r, column=colPtr).value == "Total Item Qty":
                            point = r
                            break

                    wsRESULT.insert_rows(startPtr, amount=4)

                    for c in range(1, maxCol + 1):
                        wsRESULT.cell(row=startPtr + 1, column=c).value = wsRESULT.cell(row=point + 1, column=c).value
                        wsRESULT.cell(row=startPtr + 2, column=c).value = wsRESULT.cell(row=point + 2, column=c).value
                    for r in (startPtr + 1, startPtr + 2):
                        for c in range(1, maxCol + 1):
                            cell = wsRESULT.cell(row=r, column=c)
                            cell.fill = FILL_YELLOW
                            cell.font = (cell.font or Font()).copy(bold=True)
                    for c in range(1, colPtr + 1):
                        wsRESULT.cell(row=startPtr, column=c).value = wsRESULT.cell(row=point, column=c).value
                    wsRESULT.cell(row=startPtr, column=colPtr).value = "Total PO Qty"

                    total_sum1 = 0
                    total_sum2 = 0
                    for sizeCol in range(sizeColStart, maxCol):
                        s_sum = 0
                        money_1 = None
                        money_2 = None
                        for r in range(innerStartPtr, startPtr):
                            if wsRESULT.cell(row=r, column=colPtr).value == "Total Item Qty":
                                v = wsRESULT.cell(row=r, column=sizeCol).value
                                if isinstance(v, (int, float)):
                                    s_sum += v
                                if wsRESULT.cell(row=r + 1, column=sizeCol).value not in (None, "") and money_1 is None:
                                    money_1 = wsRESULT.cell(row=r + 1, column=sizeCol).value
                                if wsRESULT.cell(row=r + 2, column=sizeCol).value not in (None, "") and money_2 is None:
                                    money_2 = wsRESULT.cell(row=r + 2, column=sizeCol).value

                        wsRESULT.cell(row=startPtr, column=sizeCol).value = s_sum if s_sum != 0 else None
                        wsRESULT.cell(row=startPtr + 1, column=sizeCol).value = money_1 if money_1 else None
                        wsRESULT.cell(row=startPtr + 2, column=sizeCol).value = money_2 if money_2 else None

                        total_sum1 += s_sum * (money_1 or 0)
                        total_sum2 += s_sum * (money_2 or 0)

                    for c in range(1, maxCol + 1):
                        cell = wsRESULT.cell(row=startPtr, column=c)
                        cell.fill = FILL_YELLOW
                        cell.font = (cell.font or Font()).copy(bold=True)

                    total_overall = 0
                    for r in range(innerStartPtr, startPtr):
                        if wsRESULT.cell(row=r, column=colPtr).value == "Total Item Qty":
                            v = wsRESULT.cell(row=r, column=maxCol).value
                            if isinstance(v, (int, float)):
                                total_overall += v
                    wsRESULT.cell(row=startPtr, column=maxCol).value = total_overall

                    for c in range(1, maxCol + 1):
                        wsRESULT.cell(row=startPtr + 3, column=c).fill = FILL_BLACK
                    wsRESULT.row_dimensions[startPtr + 3].height = 5

                    cell = wsRESULT.cell(row=startPtr + 1, column=maxCol + 1)
                    cell.value = total_sum1
                    cell.fill = FILL_YELLOW
                    cell.font = (cell.font or Font()).copy(bold=True)
                    cell = wsRESULT.cell(row=startPtr + 2, column=maxCol + 1)
                    cell.value = total_sum2
                    cell.fill = FILL_YELLOW
                    cell.font = (cell.font or Font()).copy(bold=True)

                    maxRow = wsRESULT.max_row
                    startPtr += 4
                    start += 4

        start += 1
        if start <= maxRow and wsRESULT.cell(row=start, column=colPtr).value is None:
            start += 1
            startPtr = start
        if start <= maxRow and wsRESULT.cell(row=start, column=colPtr).value == "Total Style Qty":
            start += 4
            startPtr = start

    # -------------------------------------------------------------------------
    # 4) Colorway grouping (cyan)
    # -------------------------------------------------------------------------
    log("[SecondPass] Colorway grouping (cyan).")
    maxRow = wsRESULT.max_row
    start = 2
    startPtr = start
    cwCount = 0

    def colorway_key(row):
        s = str(wsRESULT.cell(row=row, column=ctx.colStyle).value or "").strip().upper()
        if s and "-" in s:
            # substring after '-'
            pos = s.find("-")
            return s[pos:]
        return s

    curr_cw = colorway_key(start)
    prev_cw = curr_cw

    while start <= maxRow:
        if start % 300 == 0:
            log(f"[SecondPass-Colorway] row {start}/{maxRow}")

        label = wsRESULT.cell(row=start, column=colPtr).value
        if curr_cw == prev_cw and label != "Total PO Qty":
            if label == "Total Item Qty":
                cwCount += 1
            start += 1
            if start <= maxRow:
                curr_cw = colorway_key(start)
        else:
            # When cwCount >= 2, create Total Colorway Qty
            if cwCount >= 2:
                # identify latest Total Item Qty row as 'point'
                point = startPtr
                for r in range(startPtr, start):
                    if wsRESULT.cell(row=r, column=colPtr).value == "Total Item Qty":
                        point = r

                wsRESULT.insert_rows(start, amount=1)
                maxRow = wsRESULT.max_row

                for c in range(1, colPtr + 1):
                    wsRESULT.cell(row=start, column=c).value = wsRESULT.cell(row=point, column=c).value
                wsRESULT.cell(row=start, column=colPtr).value = "Total Colorway Qty"

                # sum per size
                for sizeCol in range(sizeColStart, maxCol):
                    s_sum = 0
                    for r in range(startPtr, start):
                        if wsRESULT.cell(row=r, column=colPtr).value == "Total Item Qty":
                            v = wsRESULT.cell(row=r, column=sizeCol).value
                            if isinstance(v, (int, float)):
                                s_sum += v
                    cell = wsRESULT.cell(row=start, column=sizeCol)
                    cell.number_format = "General"
                    cell.value = s_sum if s_sum != 0 else None

                for c in range(1, maxCol + 1):
                    cell = wsRESULT.cell(row=start, column=c)
                    cell.fill = FILL_CYAN
                    cell.font = (cell.font or Font()).copy(bold=True)

                total_overall = 0
                for r in range(startPtr, start):
                    if wsRESULT.cell(row=r, column=colPtr).value == "Total Item Qty":
                        v = wsRESULT.cell(row=r, column=maxCol).value
                        if isinstance(v, (int, float)):
                            total_overall += v
                wsRESULT.cell(row=start, column=maxCol).value = total_overall

                start += 1
                startPtr = start
                cwCount = 0
                if start <= maxRow:
                    curr_cw = colorway_key(start)
                    prev_cw = curr_cw

            if label == "Total PO Qty":
                start += 4
                if start <= maxRow:
                    curr_cw = colorway_key(start)

            prev_cw = curr_cw
            startPtr = start
            cwCount = 0
            if start <= maxRow:
                curr_cw = colorway_key(start)

    ctx.maxCol = wsRESULT.cell(row=1, column=wsRESULT.max_column).column
    ctx.maxRow = wsRESULT.max_row


# =============================================================================
#  AddNewColumn / RemoveColumn / RevertToOBS  (straight ports) :contentReference[oaicite:13]{index=13}
# =============================================================================

def add_new_column(wsRESULT, ctx: DPOMContext, log):
    # Insert E:I
    wsRESULT.insert_cols(5, amount=5)
    wsRESULT["E1"].value = "Job Number"
    wsRESULT["F1"].value = "Product Type"
    wsRESULT["G1"].value = "VNFOB"
    wsRESULT["H1"].value = "Destination"
    wsRESULT["I1"].value = "Blind Buy Job #"

    # Insert P
    wsRESULT.insert_cols(16, amount=1)
    wsRESULT["P1"].value = "Estimate BusWeekDate"

    ctx.maxCol = wsRESULT.cell(row=1, column=wsRESULT.max_column).column
    ctx.maxRow = wsRESULT.max_row

    # Shift column indices as in VBA
    ctx.colPO += 5
    ctx.colTradingCoPO += 5
    ctx.colPOLine += 5
    ctx.colOGAC += 6
    ctx.colDocTypeCode += 6
    ctx.colTransportation += 6
    ctx.colPtr += 6
    ctx.colShipToCusNo += 6
    ctx.colShipToCusName += 6
    ctx.colCountry += 6
    ctx.colInventorySegmentCode += 6
    ctx.colSubCategoryDesc += 6

    FtyGIPT = 10  # days
    for r in range(2, ctx.maxRow + 1):
        if r % 500 == 0:
            log(f"[AddNewColumn] row {r}/{ctx.maxRow}")

        style_val = str(wsRESULT.cell(row=r, column=ctx.colStyle).value or "").strip().upper()
        if style_val:
            wsRESULT.cell(row=r, column=7).value = "N"  # G

        og = wsRESULT.cell(row=r, column=ctx.colOGAC).value
        if og:
            # DateSerial(Format(og,"yyyymmdd")) - 10 days, then Monday of that week
            if isinstance(og, (datetime, date)):
                dt = datetime(og.year, og.month, og.day)
            else:
                s = str(og)
                for fmt in ("%Y-%m-%d", "%m/%d/%Y", "%d/%m/%Y"):
                    try:
                        dt = datetime.strptime(s, fmt)
                        break
                    except Exception:
                        dt = None
                if dt is None:
                    continue
            calc_bus = dt - timedelta(days=FtyGIPT)
            bus_week = calc_bus - timedelta(days=(calc_bus.weekday()))  # Monday
            cell = wsRESULT.cell(row=r, column=16)
            cell.value = bus_week
            cell.number_format = "mm/dd/yyyy"

        label = wsRESULT.cell(row=r, column=ctx.colPtr).value
        style_key = str(wsRESULT.cell(row=r, column=ctx.colStyle).value or "").strip().upper()
        is_blind, bbj = blind_buy_collection_contains(ctx.blind_buy, style_key)
        if label == "Total PO Qty" and is_blind and bbj:
            # column I is index 9
            wsRESULT.cell(row=r, column=9).value = bbj
            wsRESULT.cell(row=r + 1, column=9).value = bbj
            wsRESULT.cell(row=r + 2, column=9).value = bbj


def remove_column(wsRESULT, ctx: DPOMContext, log):
    start = 2
    maxRow = wsRESULT.max_row
    maxCol = wsRESULT.cell(row=1, column=wsRESULT.max_column).column

    while start <= maxRow:
        if start % 500 == 0:
            log(f"[RemoveColumn] row {start}/{maxRow}")

        label = wsRESULT.cell(row=start, column=ctx.colPtr).value

        if label == "Total Item Qty":
            wsRESULT.delete_rows(start + 1, amount=2)
            maxRow = wsRESULT.max_row

        # Border around Overall Result (last column before money)
        cell = wsRESULT.cell(row=start, column=maxCol + 1)
        val = cell.value
        if not val:
            cell.fill = FILL_WHITE
            border_color = "00D9D9D9"
        else:
            border_color = VB_BLACK
        side = Side(style="thin", color=border_color)
        cell.border = Border(left=side, right=side, top=side, bottom=side)

        if label in ("Total Style Qty", "Total PO Qty"):
            for offset in range(0, 3):
                c = wsRESULT.cell(row=start + offset, column=ctx.colStyle)
                s = str(c.value or "")
                if "-" in s:
                    c.value = s.split("-", 1)[0]

        if label == "Total OGAC Qty":
            c = wsRESULT.cell(row=start, column=ctx.colStyle)
            s = str(c.value or "")
            if "-" in s:
                c.value = s.split("-", 1)[0]

        start += 1

    ctx.maxRow = maxRow
    ctx.maxCol = wsRESULT.cell(row=1, column=wsRESULT.max_column).column
    log("[RemoveColumn] Completed.")


def revert_to_obs(wsRESULT, ctx: DPOMContext, log):
    start = 2
    maxRow = wsRESULT.max_row

    while start <= maxRow - 1:
        if start % 500 == 0:
            log(f"[RevertToOBS] row {start}/{maxRow}")

        ship_no = str(wsRESULT.cell(row=start, column=ctx.colShipToCusNo).value or "").strip()
        ship_nm = str(wsRESULT.cell(row=start, column=ctx.colShipToCusName).value or "").strip()
        label = str(wsRESULT.cell(row=start, column=ctx.colPtr).value or "").strip()

        if not ship_no and not ship_nm and label not in ("Total PO Qty", "Total OGAC Qty", "Total Colorway Qty", "Total Style Qty", ""):
            wsRESULT.cell(row=start, column=ctx.colShipToCusNo).value = "#"
            wsRESULT.cell(row=start, column=ctx.colShipToCusName).value = "#"

        if not str(wsRESULT.cell(row=start, column=ctx.colTradingCoPO).value or "").strip() and \
                str(wsRESULT.cell(row=start, column=ctx.colStyle).value or "").strip():
            wsRESULT.cell(row=start, column=ctx.colTradingCoPO).value = "-"

        # Dates in O, P, OGAC -> text "MM/dd/yyyy"
        for col in (15, 16, ctx.colOGAC):
            cell = wsRESULT.cell(row=start, column=col)
            if cell.value:
                # Format to text
                if isinstance(cell.value, (datetime, date)):
                    temp = cell.value.strftime("%m/%d/%Y")
                else:
                    s = str(cell.value)
                    parsed = None
                    for fmt in ("%Y-%m-%d", "%m/%d/%Y", "%d/%m/%Y"):
                        try:
                            parsed = datetime.strptime(s, fmt)
                            break
                        except Exception:
                            pass
                    if parsed:
                        temp = parsed.strftime("%m/%d/%Y")
                    else:
                        temp = s
                cell.number_format = "@"
                cell.value = temp
            else:
                cell.number_format = "General"

        start += 1

    # Rename headers for validation macros
    wsRESULT.cell(row=1, column=ctx.colStyle).value = "Material"
    wsRESULT.cell(row=1, column=ctx.colShipToCusName).value = "Customer Name"
    wsRESULT.cell(row=1, column=ctx.colInventorySegmentCode).value = "AFS Category"
    wsRESULT.cell(row=1, column=ctx.colSubCategoryDesc).value = "Sub Category Size Value"
    wsRESULT.cell(row=1, column=ctx.colDocTypeCode).value = "Buy Group"

    wsRESULT.cell(row=1, column=ctx.colVendor).value = "Vendor"
    wsRESULT.cell(row=1, column=ctx.colSeasonCode).value = "Planning Season"
    wsRESULT.cell(row=1, column=ctx.colSeasonYear).value = "Year"
    wsRESULT.cell(row=1, column=ctx.colPO).value = "PO Number"
    wsRESULT.cell(row=1, column=ctx.colOGAC).value = "OGAC Date"
    wsRESULT.cell(row=1, column=ctx.colTransportation).value = "Mode"

    # Insert 2 rows at top
    wsRESULT.insert_rows(1, amount=2)
    maxCol = wsRESULT.cell(row=1, column=wsRESULT.max_column).column
    wsRESULT.cell(row=2, column=maxCol).value = "Overall Result"
    wsRESULT.cell(row=3, column=maxCol).value = "TOTAL"

    # Insert column after customer name
    cust_name_col = ctx.colShipToCusName + 1  # 1-based after shifting by 2 rows
    wsRESULT.insert_cols(cust_name_col, amount=1)

    log("[RevertToOBS] Completed.")


# =============================================================================
#  AutoFit approximation
# =============================================================================

def autofit_columns(ws):
    for col in range(1, ws.max_column + 1):
        max_len = 0
        for row in range(1, ws.max_row + 1):
            val = ws.cell(row=row, column=col).value
            if val is not None:
                try:
                    l = len(str(val))
                    if l > max_len:
                        max_len = l
                except Exception:
                    pass
        ws.column_dimensions[col_lett(col)].width = max(10, min(max_len + 2, 60))


# =============================================================================
#  Module 2: SeparateDataGroups / ProcessDataGroup / IsLast :contentReference[oaicite:14]{index=14}
# =============================================================================

def separate_data_groups(ws, log):
    # First pass – process each group delimited by blank col 19
    lastRow = ws.max_row
    lastCol = ws.max_column
    startRow = 4
    currentRow = 4

    log("[SeparateDataGroups] Pass 1: split by empty plant code rows.")
    while currentRow <= lastRow:
        if not ws.cell(row=currentRow, column=19).value:
            endRow = currentRow - 1
            if endRow >= startRow:
                process_data_group(ws, startRow, endRow, lastCol, log)
                lastRow = ws.max_row
            startRow = currentRow + 1
        elif currentRow == lastRow:
            process_data_group(ws, startRow, lastRow, lastCol, log)
            lastRow = ws.max_row
        currentRow += 1

    # Second pass – clear AD/AE for Total PO Qty rows and insert black separators
    log("[SeparateDataGroups] Pass 2: cleanup AD/AE and yellow→white separators.")
    lastRow = ws.max_row
    lastCol = ws.max_column
    currentRow = 4

    while currentRow <= lastRow:
        if ws.cell(row=currentRow, column=24).value == "Total PO Qty":  # X
            ws.cell(row=currentRow, column=30).value = None  # AD
            ws.cell(row=currentRow, column=31).value = None  # AE

        fill_curr = ws.cell(row=currentRow, column=1).fill.start_color.rgb
        fill_next = ws.cell(row=currentRow + 1, column=1).fill.start_color.rgb if currentRow + 1 <= lastRow else None

        if fill_curr == vba_long_to_rgb(cYellow) and fill_next == VB_WHITE:
            ws.insert_rows(currentRow + 1, amount=1)
            for c in range(1, lastCol + 1):
                ws.cell(row=currentRow + 1, column=c).fill = FILL_BLACK
            ws.row_dimensions[currentRow + 1].height = 5
            lastRow += 1
            currentRow += 2
        else:
            currentRow += 1


def process_data_group(ws, startRow: int, endRow: int, endCol: int, log):
    # Direct translation of VBA ProcessDataGroup. :contentReference[oaicite:15]{index=15}
    if startRow > endRow:
        return

    # Identify plant code differences (col 19)
    hasDifference = False
    for i in range(startRow + 1, endRow + 1):
        if ws.cell(row=i, column=19).value != ws.cell(row=i - 1, column=19).value:
            hasDifference = True
            break

    # Identify white and yellow rows
    whiteRows = []
    yellowRows = []
    cyanFound = False

    for i in range(startRow, endRow + 1):
        color = ws.cell(row=i, column=1).fill.start_color.rgb
        if color == VB_WHITE:
            whiteRows.append(i)
        elif color == vba_long_to_rgb(cYellow):
            yellowRows.append(i)

    # Remove cyan rows
    i = startRow
    while i <= endRow:
        color = ws.cell(row=i, column=1).fill.start_color.rgb
        if color == vba_long_to_rgb(cCyan):
            cyanFound = True
            ws.delete_rows(i, amount=1)
            endRow -= 1
        else:
            i += 1

    # If original criteria met (has plant difference + cyanFound)
    if hasDifference and cyanFound:
        log(f"[ProcessDataGroup] Plant-code split + cyan from rows {startRow}-{endRow}.")
        newRow = startRow
        insertCount = 0

        # Convert index lists to copies (VBA stores Row objects; we store row indices)
        whiteIndices = whiteRows[:]
        yellowIndices = yellowRows[:]

        for idx, wRow in enumerate(whiteIndices, start=1):
            # Copy white row
            ws.insert_rows(newRow, amount=1)
            for c in range(1, endCol + 1):
                ws.cell(row=newRow, column=c).value = ws.cell(row=wRow + insertCount, column=c).value
            newRow += 1
            insertCount += 1

            # Copy all yellow rows
            for yRow in yellowIndices:
                ws.insert_rows(newRow, amount=1)
                for c in range(1, endCol + 1):
                    ws.cell(row=newRow, column=c).value = ws.cell(row=yRow + insertCount, column=c).value
                # Copy plant info from white row into col N (14) & S (19)
                ws.cell(row=newRow, column=14).value = ws.cell(row=wRow + insertCount, column=14).value
                ws.cell(row=newRow, column=19).value = ws.cell(row=wRow + insertCount, column=19).value

                # If yellow row has value in AK (endCol-1), copy AE:AK (31..endCol-1) from white row
                if ws.cell(row=newRow, column=endCol - 1).value not in (None, ""):
                    for k in range(31, endCol):
                        ws.cell(row=newRow, column=k).value = ws.cell(row=wRow + insertCount, column=k).value

                if yRow != yellowIndices[0]:
                    for k in range(31, endCol - 1):
                        if ws.cell(row=wRow + insertCount, column=k).value in (None, ""):
                            ws.cell(row=newRow, column=k).value = ""

                newRow += 1
                insertCount += 1

            # Separator row between white-groups
            if idx < len(whiteIndices):
                ws.insert_rows(newRow, amount=1)
                for c in range(1, endCol):
                    ws.cell(row=newRow, column=c).fill = FILL_BLACK
                ws.row_dimensions[newRow].height = 5
                newRow += 1
                insertCount += 1

        # Delete original rows after splitted block
        ws.delete_rows(newRow, amount=(endRow + insertCount - newRow + 1 if endRow + insertCount >= newRow else 0))
    else:
        # NEW implementation branch in VBA: Mexico/Indonesia/Canada / VL/TR logic
        shouldUseDifferentSplitLogic = False

        for row_idx in whiteRows:
            colAB = str(ws.cell(row=row_idx, column=28).value or "").strip()  # AB
            colY = ws.cell(row=row_idx, column=25).value  # Y
            colW = str(ws.cell(row=row_idx, column=23).value or "").strip()  # W
            colYIsNumeric = isinstance(colY, (int, float))

            cond1 = (colAB in ("Mexico", "Indonesia", "Canada") and not colYIsNumeric and colW in ("VL", "TR"))
            cond2 = (colYIsNumeric and colW in ("VL", "TR"))
            if cond1 or cond2:
                shouldUseDifferentSplitLogic = True
                break

        if shouldUseDifferentSplitLogic:
            # Collect distinct col D values from white rows
            distinctD = []
            for row_idx in whiteRows:
                v = ws.cell(row=row_idx, column=4).value
                if v not in distinctD:
                    distinctD.append(v)

            hasDifference = len(distinctD) > 1 or cyanFound
            if hasDifference:
                log(f"[ProcessDataGroup] Alternative split by column D (rows {startRow}-{endRow}).")
                newRow = startRow
                insertCount = 0

                for d_idx, d_val in enumerate(distinctD):
                    # All white rows with this D
                    group_white = [r for r in whiteRows if ws.cell(row=r, column=4).value == d_val]

                    for wRow in group_white:
                        ws.insert_rows(newRow, amount=1)
                        for c in range(1, endCol + 1):
                            ws.cell(row=newRow, column=c).value = ws.cell(row=wRow + insertCount, column=c).value
                        newRow += 1
                        insertCount += 1

                        for yRow in yellowRows:
                            ws.insert_rows(newRow, amount=1)
                            for c in range(1, endCol + 1):
                                ws.cell(row=newRow, column=c).value = ws.cell(row=yRow + insertCount, column=c).value
                            ws.cell(row=newRow, column=14).value = ws.cell(row=wRow + insertCount, column=14).value
                            ws.cell(row=newRow, column=19).value = ws.cell(row=wRow + insertCount, column=19).value

                            if ws.cell(row=newRow, column=endCol - 1).value not in (None, ""):
                                for k in range(31, endCol):
                                    ws.cell(row=newRow, column=k).value = ws.cell(row=wRow + insertCount, column=k).value

                            if yRow != yellowRows[0]:
                                for k in range(31, endCol - 1):
                                    if ws.cell(row=wRow + insertCount, column=k).value in (None, ""):
                                        ws.cell(row=newRow, column=k).value = ""

                            newRow += 1
                            insertCount += 1

                    # Separator row between distinct D groups
                    if not is_last(distinctD, d_val):
                        ws.insert_rows(newRow, amount=1)
                        for c in range(1, endCol):
                            ws.cell(row=newRow, column=c).fill = FILL_BLACK
                        ws.row_dimensions[newRow].height = 5
                        newRow += 1
                        insertCount += 1

                # Delete original
                ws.delete_rows(newRow, amount=(endRow + insertCount - newRow + 1 if endRow + insertCount >= newRow else 0))


def is_last(collection: List[Any], item: Any) -> bool:
    return collection and collection[-1] == item


# =============================================================================
#  UI Widget (your original skeleton, unchanged)
# =============================================================================

class MainWidget(QWidget):
    log_message = Signal(str)
    processing_done = Signal(int, int, str)

    def __init__(self):
        super().__init__()
        self.setObjectName("dpom_sorter_widget")
        self._build_ui()
        self._connect_signals()

    # UI
    def _build_ui(self):
        # DEFINE WIDGETS
        # Description
        self.desc_label = QLabel("", self)
        self.desc_label.setWordWrap(True)
        self.desc_label.setSizePolicy(QSizePolicy.Expanding, QSizePolicy.Preferred)
        self.desc_label.setAlignment(Qt.AlignLeft | Qt.AlignTop)
        self.desc_label.setTextInteractionFlags(Qt.TextSelectableByMouse)
        self.desc_label.setStyleSheet(
            "color: #dcdcdc; background: transparent; padding: 6px; "
            "border: 1px solid #3a3a3a; border-radius: 6px;"
        )
        self.set_long_description("")

        # Buttons
        self.select_btn2 = PrimaryPushButton("Select Size Excel", self)
        self.select_btn = PrimaryPushButton("Select Raw DPOM Excel Files", self)
        self.run_btn = PrimaryPushButton("Run", self)

        # Labels
        self.files_label = QLabel("Selected files", self)
        self.files_label.setAlignment(Qt.AlignLeft | Qt.AlignVCenter)
        self.files_label.setStyleSheet("color: #dcdcdc; background: transparent; padding-left: 2px;")
        self.logs_label = QLabel("Process logs", self)
        self.logs_label.setAlignment(Qt.AlignLeft | Qt.AlignVCenter)
        self.logs_label.setStyleSheet("color: #dcdcdc; background: transparent; padding-left: 2px;")

        # Text boxes
        self.files_box = QTextEdit(self)
        self.files_box.setReadOnly(True)
        self.files_box.setPlaceholderText("Selected files will appear here")
        self.files_box.setStyleSheet(
            "QTextEdit{background: #1f1f1f; color: #d0d0d0; "
            "border: 1px solid #3a3a3a; border-radius: 6px;}"
        )

        self.files_box2 = QTextEdit(self)
        self.files_box2.setReadOnly(True)
        self.files_box2.setMaximumHeight(50)
        self.files_box2.setPlaceholderText("Selected size file will appear here")
        self.files_box2.setStyleSheet(
            "QTextEdit{background: #1f1f1f; color: #d0d0d0; "
            "border: 1px solid #3a3a3a; border-radius: 6px;}"
        )

        self.log_box = QTextEdit(self)
        self.log_box.setReadOnly(True)
        self.log_box.setPlaceholderText("Live process log will appear here")
        self.log_box.setStyleSheet(
            "QTextEdit{background: #1f1f1f; color: #d0d0d0; "
            "border: 1px solid #3a3a3a; border-radius: 6px;}"
        )

        # Layouts
        main_layout = QVBoxLayout(self)
        main_layout.setContentsMargins(16, 16, 16, 16)
        main_layout.setSpacing(12)
        main_layout.addWidget(self.desc_label, 1)

        row1_layout = QHBoxLayout()
        row1_layout.addStretch(1)
        row1_layout.addWidget(self.select_btn2, 1)
        row1_layout.addStretch(1)
        main_layout.addLayout(row1_layout, 0)

        row2_layout = QHBoxLayout()
        row2_layout.addWidget(self.files_box2, 1)
        main_layout.addLayout(row2_layout, 0)

        row3_layout = QHBoxLayout()
        row3_layout.addWidget(self.select_btn, 1)
        row3_layout.addWidget(self.run_btn, 1)
        main_layout.addLayout(row3_layout, 0)

        row4_layout = QHBoxLayout()
        row4_layout.addWidget(self.files_label, 1)
        row4_layout.addWidget(self.logs_label, 1)
        main_layout.addLayout(row4_layout, 0)

        row5_layout = QHBoxLayout()
        row5_layout.addWidget(self.files_box, 1)
        row5_layout.addWidget(self.log_box, 1)
        main_layout.addLayout(row5_layout, 4)

    def set_long_description(self, text: str):
        clean = (text or "").strip()
        if clean:
            self.desc_label.setText(clean)
            self.desc_label.show()
        else:
            self.desc_label.clear()
            self.desc_label.hide()

    def _connect_signals(self):
        self.select_btn2.clicked.connect(self.select_size_file)
        self.select_btn.clicked.connect(self.select_files)
        self.run_btn.clicked.connect(self.run_process)
        self.log_message.connect(self.append_log)
        self.processing_done.connect(self.on_processing_done)

    def select_size_file(self):
        file_path, _ = QFileDialog.getOpenFileName(self, "Select Size / Blind Buy workbook")
        if file_path:
            self.files_box2.setPlainText(file_path)
        else:
            self.files_box2.clear()

    def _selected_size_file(self) -> str:
        return self.files_box2.toPlainText().strip()

    def select_files(self):
        files, _ = QFileDialog.getOpenFileNames(self, "Select")
        if files:
            self.files_box.setPlainText("\n".join(files))
        else:
            self.files_box.clear()

    def _selected_files(self) -> List[str]:
        text = self.files_box.toPlainText().strip()
        if not text:
            return []
        return [line for line in text.split("\n") if line.strip()]

    def run_process(self):
        size_file = self._selected_size_file()
        if not size_file:
            MessageBox("Warning", "Size / Blind Buy workbook not selected.", self).exec()
            return
        files = self._selected_files()
        if not files:
            MessageBox("Warning", "Nothing to process.", self).exec()
            return

        self.log_box.clear()
        self.log_message.emit("Process starts")
        self.run_btn.setEnabled(False)
        self.select_btn.setEnabled(False)

        def worker():
            out_path = ""
            ok = 0
            fail = 0
            try:
                out_path, ok, fail = process_files(size_file, files, self.log_message.emit)
            except Exception as e:
                self.log_message.emit(f"ERROR: {e}")
            self.processing_done.emit(ok, fail, out_path)

        threading.Thread(target=worker, daemon=True).start()

    def append_log(self, text: str):
        self.log_box.append(text)
        self.log_box.ensureCursorVisible()

    def on_processing_done(self, ok: int, fail: int, out_path: str):
        if out_path:
            self.log_message.emit(f"Output workbook saved to: {out_path}")
        self.log_message.emit(f"Completed: {ok} success, {fail} failed.")
        self.run_btn.setEnabled(True)
        self.select_btn.setEnabled(True)


def get_widget():
    return MainWidget()
